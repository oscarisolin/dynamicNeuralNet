<!DOCTYPE html>
<html>
    <head>
        <script src="https://d3js.org/d3.v6.min.js"></script>
    </head>
    <body>
		<svg width=300 height=300></svg>
		<script>

			function intensity(d) {
				let begin = d3.color("steelblue");
				begin.opacity = 0.1;
				let end = d3.color("red");
				let scale = d3.scaleLinear([0, 100], [begin, end]).clamp(true);

				if (typeof d.activity_state == 'undefined') {
					return begin;
				}
				return scale(d.activity_state);
			}
			
			function dragstarted(event, d) {
				if (!event.active) simulation.alphaTarget(0.3).restart();
				d.fx = d.x;
				d.fy = d.y;
			}

				function dragged(event, d) {
				d.fx = event.x;
				d.fy = event.y;
			}

			function dragended(event, d) {
				if (!event.active) simulation.alphaTarget(0);
				d.fx = null;
				d.fy = null;
			}

			function init_simulation(data, simulation) {
				if (typeof simulation != 'undefined'){
					simulation.stop();
					simulation
					.force("center_gravity",d3.forceCenter(150,150).strength(0.2))
					.force("repel", d3.forceManyBody()).on('tick',ticked)
					.force("link", d3.forceLink(d3_links).id(d => d.id)).on('tick',ticked);
					simulation.restart();
					return simulation;
					
				}else{
					return d3.forceSimulation(data.nodes)
					.force("center_gravity",d3.forceCenter(150,150).strength(0.2))
					.force("repel", d3.forceManyBody()).on('tick',ticked)
					.force("link", d3.forceLink(d3_links).id(d => d.id)).on('tick',ticked);				

				}
			}
		
			
			function ticked() {
				svg.selectAll("line").data(data.links).join("line")
				.attr("x1",d => data.nodes.find(k => k.id == d.l[0]).x)
				.attr("y1",d => data.nodes.find(k => k.id == d.l[0]).y)
				.attr("x2",d => data.nodes.find(k => k.id == d.l[1]).x)
				.attr("y2",d => data.nodes.find(k => k.id == d.l[1]).y)
				.attr("cnn_source_id",d => d.l[0])
				.attr("cnn_target_id",d => d.l[1])
				.attr("cnn_activity_state",d => d.activity_state)
				.attr("stroke", intensity)
				// .style("fill",intensity)				
				.attr("stroke-width", 1)
				.call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended))

				
				svg.selectAll("circle").data(data.nodes).join("circle")
				.style("fill",intensity)
				.attr("cx",d=>d.x)
				.attr("cy",d=>d.y)
				// .attr("r",d=>d.r)
				.attr("cnn_node_id",d=>d.id)
				.attr("cnn_activity_state",d => d.activity_state)
				.attr("r",2)
				.call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended))


			}

			let data = { "nodes":[
							{"id": 0, "activity_state": 12},{"id": 1},{"id": 4},{"id": 7, "activity_state": 90}	
						],
						"links":[
							{"l": [0,4]},	{"l": [0,1]},	{"l": [0,7], "activity_state": 50}
						]
			}

			let d3_links = data.links.map(k=>{return {"source":k.l[0],"target":k.l[1]}});
			let svg = d3.select("svg");

			let simulation = init_simulation(data);

			// const simulation = d3.forceSimulation(data.nodes);
			
			// simulation
			// .force("center_gravity",d3.forceCenter(150,150).strength(0.2))
			// .force("repel", d3.forceManyBody()).on('tick',ticked)
			// .force("link", d3.forceLink(d3_links).id(d => d.id)).on('tick',ticked);
			// .distance(20)

			

			var ws = new WebSocket("ws://localhost:5678");
			ws.onmessage = function (event) {
				var obj = JSON.parse(event.data);
//				var a = {"activity_state": obj.activity_state};
				var a = obj;
				
				let data = obj;
				let d3_links = data.links.map(k=>{return {"source":k.l[0],"target":k.l[1]}})

				// data.nodes.push(a.nodes);
				// data.links.push(a.links);

				// const simulation = d3.forceSimulation(data);
				// simulation.force("center_gravity",d3.forceCenter(150,150)).force("repel", d3.forceManyBody().strength(2)).on('tick',ticked)
				
				simulation = (data, simulation);
				

				// const simulation = d3.forceSimulation(data.nodes);
			
				// simulation
				// .force("center_gravity",d3.forceCenter(150,150).strength(0.2))
				// // .force("repel", d3.forceManyBody()).on('tick',ticked)
				// .force("link", d3.forceLink(d3_links).id(d => d.id)).on('tick',ticked);

				
				console.log(data);
			};

		</script>
    </body>
</html>
